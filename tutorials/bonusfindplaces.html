<!DOCTYPE html>

<html>
    <head>
        <!-- Tutorial completed by Helen Plesko on February 3, 2024 -->
        <!-- See Bug Report for details on how I debugged the tutorial code -->

        <meta charset="utf-8" />
        <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no" />
        <title>ArcGIS Maps SDK for JavaScript Tutorials: Find places</title>

        <style>
            html,
            body,
            #viewDiv {
                padding: 0;
                margin: 0;
                height: 100%;
                width: 100%;
            }
        </style>

        <!-- References to the CSS file and JS library -->
        <link rel="stylesheet" href="https://js.arcgis.com/4.28/esri/themes/light/main.css" />
        <script src="https://js.arcgis.com/4.28/"></script>

        <!-- Load the Map and MapView modules with the require function -->
        <script>
            require([
                "esri/config",
                "esri/Map",
                "esri/views/MapView",
                "esri/rest/locator",
                "esri/Graphic",
                "esri/core/reactiveUtils"
                ], (esriConfig, Map, MapView, locator, Graphic, reactiveUtils) => {
                
                // API Key created in ArcGIS Developers
                esriConfig.apiKey = "AAPK1e47e0df150146abb6a14f0a1895d872cu1-mLpenYEaDB6pWEDv6B5Qc9CiQvtuFUp6wlIQ1OjmC2ojvHhWO0ZqhINUkE5I";

                // Creating new map, where the basemap is navigation
                // Basemap source: https://developers.arcgis.com/javascript/3/jsapi/esri.basemaps-amd.html
                const map = new Map({
                    basemap: "streets-navigation-vector" // basemap styles service accessed with API Key
                });

                // Create a MapView, so the map is centered on Tromso
                const view = new MapView({
                    container: "viewDiv",
                    map: map,
                    center: [18.9553, 69.6492], // Longitude, latitude for Tromso
                    zoom: 13
                });

                // Create a place category selector
                const places = ["Choose a place type...", "Parks and Outdoors", "Coffee shop", "Gas station", "Food", "Hotel"];

                // Create a select element for the search categories and assign styles to them
                const select = document.createElement("select");
                select.setAttribute("class", "esri-widget esri-select");
                select.setAttribute("style", "width: 175px; font-family: 'Avenir Next W00'; font-size: 1em");

                // Create an option element for each category and add it to the select element
                places.forEach((p) => {
                    const option = document.createElement("option");
                    option.value = p;
                    option.innerHTML = p;
                    select.appendChild(option);
                });

                // Add select element to the top-right corner of the view
                view.ui.add(select, "top-right");

                // Add a locator to access the Geocoding service
                const locatorUrl = "http://geocode-api.arcgis.com/arcgis/rest/services/World/GeocodeServer";

                // Add the ability to find places and add them to the map
                function findPlaces(category, pt) {
                    locator
                        .addressToLocations(locatorUrl, {
                            location: pt,
                            categories: [category],
                            maxLocations: 25,
                            outFields: ["Place_addr", "PlaceName"]
                        })

                        // Clear the view of existing pop-ups and graphics
                        .then((results) => { 
                            view.closePopup();
                            view.graphics.removeAll();

                            // Create graphic for each result returned
                            results.forEach((result) => {
                                view.graphics.add(
                                    new Graphic({
                                        attributes: result.attributes, // Data attributes returned
                                        geometry: result.location, // Point returned
                                        symbol: {
                                            type: "simple-marker",
                                            color: "#000000",
                                            size: "12px",
                                            outline: {
                                                color: "#ffffff",
                                                width: "2px"
                                            }
                                        },
                                        popupTemplate: {
                                            title: "{PlaceName}", // Data attribute names
                                            content: "{Place_addr}"
                                        }
                                    })
                                );
                            });
                        });
                }

                // Search for places in center of map
                reactiveUtils.when(
                    () => view.stationary,
                    () => {
                        findPlaces(select.value, view.center);
                    }
                );

                // Listen for category changes and find places
                select.addEventListener("change", (event) => {
                    findPlaces(event.target.value, view.center);
                });

            });
        </script>

    </head>
    
    <body>

        <!-- Div to hold map -->
        <div id="viewDiv"></div>

    </body>
</html>